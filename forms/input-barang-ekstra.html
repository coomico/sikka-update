<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Data Barang Ekstra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../dist/base.css" rel="stylesheet">
    <link href="../dist/barang.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://kit.fontawesome.com/d0daa1cbe3.js" crossorigin="anonymous"></script>
    <script src="../dist/xlsx.bundle.js"></script>
    <script src="../dist/cell.style.js"></script>
    <script src="../dist/utils.js"></script>
</head>
<body>
    <div class="container-lg mt-4 mb-4 px-4">
        <h2 class="text-center mb-4">Input Data Barang Ekstra</h2>
        <form id="barangForm">
            <div class="card card-style p-3 mb-4">
                <h5 class="card-title">Periode</h5>
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label">Awal</label>
                        <input type="date" class="form-control periodeAwal" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Akhir</label>
                        <input type="date" class="form-control periodeAkhir" required>
                    </div>
                </div>
            </div>
            <div id="groupContainer">
                <div class="group-entry">
                    <div class="table-container-wrapper mt-3">
                        <div class="table-container">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th rowspan="3">AKSI</th>
                                        <th rowspan="2" colspan="2">LIST BARANG ESKTRAKOMPTABEL (DI LUAR NERACA)</th>
                                        <th rowspan="3">Satuan</th>
                                        <th rowspan="2" colspan="2">SALDO AWAL</th>
                                        <th colspan="4">MUTASI</th>
                                    </tr>
                                    <tr>
                                    <th colspan="2">BERTAMBAH</th>
                                    <th colspan="2">BERKURANG</th>
                                    </tr>
                                    <tr>
                                        <th>Kode</th>
                                        <th>Uraian</th>
                                        <th>Kuantitas</th>
                                        <th>Nilai</th>
                                        <th>Kuantitas</th>
                                        <th>Nilai</th>
                                        <th>Kuantitas</th>
                                        <th>Nilai</th>
                                    </tr>
                                </thead>
                                <tbody class="barang-list">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-success addBarang mt-2">
                        <i class="fa-solid fa-plus"></i>
                        Tambah Barang
                    </button>
                </div>
            </div>
            <div class="action-buttons">
                <button type="button" class="btn btn-success" id="saveData">
                    <i class="fa-solid fa-floppy-disk"></i>
                    Simpan
                </button>
                <button type="button" class="btn btn-secondary" id="exportExcel" disabled>
                    <i class="fa-solid fa-file-export"></i>
                    Unduh (.xlsx)
                </button>
                <button type="button" class="btn btn-secondary" id="printReport" disabled>
                    <i class="fa-solid fa-eye"></i>
                    Lihat Laporan
                </button>
            </div>
        </form>
    </div>

    <script>
        const barangTemplate = `
            <td>
                <div class="row-actions">
                    <button type="button" class="btn btn-primary btn-sm duplicate-barang" title="Duplicate">
                        <i class="fa-regular fa-copy"></i>
                    </button>
                    <button type="button" class="btn btn-danger btn-sm remove-barang" title="Delete">
                        <i class="fa-regular fa-trash-can"></i>
                    </button>
                </div>
            </td>
            <td><input type="text" class="form-control kode" required></td>
            <td><input type="text" class="form-control uraian" required></td>
            <td><input type="text" class="form-control satuan" required></td>
            <td><input type="number" class="form-control kuantitasAwal" required></td>
            <td><input type="number" class="form-control nilaiAwal" required></td>
            <td><input type="number" class="form-control kuantitasTambah" required></td>
            <td><input type="number" class="form-control nilaiTambah" required></td>
            <td><input type="number" class="form-control kuantitasKurang" required></td>
            <td><input type="number" class="form-control nilaiKurang" required></td>
        `;

        function addBarangRow(tbody) {
            const row = document.createElement('tr');
            row.innerHTML = barangTemplate;
            attachBarangRowEvents(row);
            tbody.appendChild(row);
        }

        function attachBarangRowEvents(row) {
            row.querySelector('.remove-barang').addEventListener('click', function() {
                row.remove();
            });

            row.querySelector('.duplicate-barang').addEventListener('click', function() {
                const newRow = document.createElement('tr');
                newRow.innerHTML = barangTemplate;
                
                // Copy values from current row to new row
                const inputs = row.querySelectorAll('input');
                const newInputs = newRow.querySelectorAll('input');
                inputs.forEach((input, index) => {
                    newInputs[index].value = input.value;
                });

                attachBarangRowEvents(newRow);
                row.parentNode.insertBefore(newRow, row.nextSibling);
            });
        }

        document.querySelector('.addBarang').addEventListener('click', function() {
            addBarangRow(document.querySelector('.barang-list'));
        });

        document.getElementById('saveData').addEventListener('click', function() {
            const data = collectFormData();
            if (validateData(data)) {
                localStorage.setItem('barangData', JSON.stringify(data.barangData));
                localStorage.setItem('metadata', JSON.stringify(data.metadata));
                document.getElementById('exportExcel').disabled = false;
                document.getElementById('printReport').disabled = false;
                alert('Data berhasil disimpan!');
            }
        });

        function collectFormData() {
            const metadata = {
                periodeAwal: document.querySelector('.periodeAwal').value,
                periodeAkhir: document.querySelector('.periodeAkhir').value
            };

            const barangData = [];
            document.querySelectorAll('.barang-list > tr').forEach(barang => {
                barangData.push({
                    kode: barang.querySelector('.kode').value,
                    uraian: barang.querySelector('.uraian').value,
                    satuan: barang.querySelector('.satuan').value,
                    kuantitasAwal: Number(barang.querySelector('.kuantitasAwal').value),
                    nilaiAwal: Number(barang.querySelector('.nilaiAwal').value),
                    kuantitasTambah: Number(barang.querySelector('.kuantitasTambah').value),
                    nilaiTambah: Number(barang.querySelector('.nilaiTambah').value),
                    kuantitasKurang: Number(barang.querySelector('.kuantitasKurang').value),
                    nilaiKurang: Number(barang.querySelector('.nilaiKurang').value)
                });
            });

            return { metadata, barangData };
        }

        // Validate data
        function validateData(data) {
            if (!data.metadata.periodeAwal || !data.metadata.periodeAkhir) {
                alert('Periode harus diisi!');
                return false;
            }
            if (data.barangData.length === 0) {
                alert('Minimal harus ada satu barang!');
                return false;
            }
            return true;
        }

        // Event handler for Excel export
        document.getElementById('exportExcel').addEventListener('click', function() {
            const data = JSON.parse(localStorage.getItem('barangData'));
            const metadata = JSON.parse(localStorage.getItem('metadata'));
            
            const wb = XLSX.utils.book_new();
            const ws_data = [];

            const textSaldoAwal =  `SALDO AWAL ${dateFormatter(new Date(metadata.periodeAwal)).toUpperCase()}`;
            const textSaldoAkhir = `SALDO AKHIR ${dateFormatter(new Date(metadata.periodeAkhir)).toUpperCase()}`;
            
            // Header rows
            ws_data.push([
                'LIST BARANG ESKTRAKOMPTABEL (DI LUAR NERACA)', 'LIST BARANG ESKTRAKOMPTABEL (DI LUAR NERACA)', 'SATUAN',
                textSaldoAwal, textSaldoAwal,
                'MUTASI', 'MUTASI', 'MUTASI', 'MUTASI',
                textSaldoAkhir, textSaldoAkhir
            ]);
            ws_data.push([
                '', '', '', 
                '', '',
                'BERTAMBAH', 'BERTAMBAH', 'BERKURANG', 'BERKURANG',
                '', ''
            ]);
            ws_data.push([
                'Kode', 'Uraian', '',
                'Kuantitas', 'Nilai',
                'Kuantitas', 'Nilai', 'Kuantitas', 'Nilai',
                'Kuantitas', 'Nilai'
            ]);
            ws_data.push([
                '1', '2', '3',
                '4', '5',
                '6', '7', '8', '9',
                '10', '11'
            ]);

            // Pre-calculate group totals
            let totalKuantitasAwal = 0;
            let totalNilaiAwal = 0;
            let totalKuantitasTambah = 0;
            let totalNilaiTambah = 0;
            let totalKuantitasKurang = 0;
            let totalNilaiKurang = 0;
            let totalKuantitasAkhir = 0;
            let totalNilaiAkhir = 0;
            
            data.forEach(barang => {
                totalKuantitasAwal += Number(barang.kuantitasAwal) || 0;
                totalNilaiAwal += Number(barang.nilaiAwal) || 0;
                totalKuantitasTambah += Number(barang.kuantitasTambah) || 0;
                totalNilaiTambah += Number(barang.nilaiTambah) || 0;
                totalKuantitasKurang += Number(barang.kuantitasKurang) || 0;
                totalNilaiKurang += Number(barang.nilaiKurang) || 0;
                totalKuantitasAkhir += (Number(barang.kuantitasAwal) + Number(barang.kuantitasTambah) - Number(barang.kuantitasKurang)) || 0;
                totalNilaiAkhir += (Number(barang.nilaiAwal) + Number(barang.nilaiTambah) - Number(barang.nilaiKurang)) || 0;
            });

            let rowNumber = 5;
            const startGroupRow = rowNumber + 1;

            // Add group row with both formulas and pre-calculated values
            ws_data.push([
                '',
                '',
                '',
                { t: 'n', v: totalKuantitasAwal, f: `SUM(D${startGroupRow}:D${startGroupRow + data.length - 1})` },
                { t: 'n', v: totalNilaiAwal, f: `SUM(E${startGroupRow}:E${startGroupRow + data.length - 1})` },
                { t: 'n', v: totalKuantitasTambah, f: `SUM(F${startGroupRow}:F${startGroupRow + data.length - 1})` },
                { t: 'n', v: totalNilaiTambah, f: `SUM(G${startGroupRow}:G${startGroupRow + data.length - 1})` },
                { t: 'n', v: totalKuantitasKurang, f: `SUM(H${startGroupRow}:H${startGroupRow + data.length - 1})` },
                { t: 'n', v: totalNilaiKurang, f: `SUM(I${startGroupRow}:I${startGroupRow + data.length - 1})` },
                { t: 'n', v: totalKuantitasAkhir, f: `SUM(J${startGroupRow}:J${startGroupRow + data.length - 1})` },
                { t: 'n', v: totalNilaiAkhir, f: `SUM(K${startGroupRow}:K${startGroupRow + data.length - 1})` }
            ]);
            
            rowNumber++;

            // Add item rows with both formulas and pre-calculated values
            data.forEach(barang => {
                const saldoAkhirKuantitas = (Number(barang.kuantitasAwal) + Number(barang.kuantitasTambah) - Number(barang.kuantitasKurang)) || 0;
                const saldoAkhirNilai = (Number(barang.nilaiAwal) + Number(barang.nilaiTambah) - Number(barang.nilaiKurang)) || 0;
                
                ws_data.push([
                    barang.kode,
                    barang.uraian,
                    barang.satuan,
                    Number(barang.kuantitasAwal) || 0,
                    Number(barang.nilaiAwal) || 0,
                    Number(barang.kuantitasTambah) || 0,
                    Number(barang.nilaiTambah) || 0,
                    Number(barang.kuantitasKurang) || 0,
                    Number(barang.nilaiKurang) || 0,
                    { t: 'n', v: saldoAkhirKuantitas, f: `D${rowNumber}+F${rowNumber}-H${rowNumber}` },
                    { t: 'n', v: saldoAkhirNilai, f: `E${rowNumber}+G${rowNumber}-I${rowNumber}` }
                ]);
                
                rowNumber++;
            });
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // Apply styles to all cells
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; R++) {
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cellRef]) ws[cellRef] = { v: '' };
                    
                    if (R < 3) {
                        ws[cellRef].s = headerStyle;
                    } else if (R === 3) {
                        ws[cellRef].s = headerNumberStyle;
                    } else {
                        // Apply number format to numeric columns
                        if ([3,4,5,6,7,8,9,10].includes(C)) {
                            ws[cellRef].s = numberStyle;
                        } else {
                            ws[cellRef].s = dataStyle;
                        }

                        if ((startGroupRow - 2) === R) {
                            ws[cellRef].s = {
                                ...ws[cellRef].s,
                                font: {
                                    bold: true,
                                },
                                fill: {
                                    patternType: 'solid',
                                    fgColor: { rgb: "C9C9C9" }
                                }
                            }
                        }
                    }
                }
            }
            
            // Set column widths
            ws['!cols'] = [
                {wch: 30}, // Kode
                {wch: 30}, // Uraian
                {wch: 8},  // Satuan
                {wch: 12}, // Kuantitas Awal
                {wch: 15}, // Nilai Awal
                {wch: 12}, // Kuantitas Tambah
                {wch: 15}, // Nilai Tambah
                {wch: 12}, // Kuantitas Kurang
                {wch: 15}, // Nilai Kurang
                {wch: 12}, // Kuantitas Akhir
                {wch: 15}  // Nilai Akhir
            ];
            
            // Merge cells for headers
            ws['!merges'] = [
                // Merge untuk header baris pertama
                {s: {r: 0, c: 0}, e: {r: 1, c: 1}}, // LIST BARANG ESKTRAKOMPTABEL
                {s: {r: 0, c: 2}, e: {r: 2, c: 2}}, // SATUAN
                {s: {r: 0, c: 3}, e: {r: 1, c: 4}}, // SALDO AWAL
                {s: {r: 0, c: 5}, e: {r: 0, c: 8}}, // MUTASI
                {s: {r: 0, c: 9}, e: {r: 1, c: 10}}, // SALDO AKHIR
                
                // Merge untuk header baris kedua
                {s: {r: 1, c: 5}, e: {r: 1, c: 6}}, // BERTAMBAH
                {s: {r: 1, c: 7}, e: {r: 1, c: 8}}  // BERKURANG
            ];
            
            // Add sheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "LAP BARANG EKSTRA");

            // Write file with all formatting options enabled
            XLSX.writeFile(wb, `Laporan_Barang_Ekstra_${metadata.periodeAwal}_${metadata.periodeAkhir}.xlsx`, {
                bookType: 'xlsx',
                bookSST: false,
                type: 'binary',
                cellStyles: true,
                compression: true
            });
        });

        // Print report
        document.getElementById('printReport').addEventListener('click', function() {
            window.open('../views/lap-barang-ekstra-view.html', '_blank');
        });
    </script>
</body>
</html>